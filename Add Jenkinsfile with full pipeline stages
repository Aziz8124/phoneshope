pipeline {
    agent any

    tools {
        maven 'Maven_3.8.8'   // تأكد أن الاسم مطابق لما هو مضاف في Jenkins
        jdk 'Java_17'         // تأكد أن JDK 17 معرف في Jenkins
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/Aziz8124/phoneshope.git'
            }
        }

        stage('Build with Maven') {
            steps {
                bat 'mvn clean compile'
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def testExists = fileExists('src/test/java')
                    if (testExists) {
                        bat 'mvn test'
                    } else {
                        echo 'لا توجد اختبارات، تخطي هذه المرحلة.'
                    }
                }
            }
        }

        stage('Package') {
            steps {
                bat 'mvn package'
            }
        }

        stage('Archive Artifact') {
            steps {
                archiveArtifacts artifacts: 'target\\*.jar', fingerprint: true
            }
        }

        stage('Run App') {
            steps {
                bat 'start /B java -jar target\\phoneshope-0.0.1-SNAPSHOT.jar'
            }
        }
    }

    post {
        success {
            echo '✅ Pipeline اكتملت بنجاح!'
        }
        failure {
            echo '❌ Pipeline فشلت، تحقق من الأخطاء أعلاه.'
        }
    }
}
